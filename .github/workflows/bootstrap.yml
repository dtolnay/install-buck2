name: Bootstrap

on:
  push:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  install:
    name: Bootstrap buck2 on ${{matrix.os == 'ubuntu' && 'Linux' || matrix.os == 'macos' && 'macOS' || matrix.os == 'windows' && 'Windows' || '???'}}
    runs-on: ${{matrix.os}}-latest
    strategy:
      fail-fast: false
      matrix:
        os:
          #- ubuntu
          #- macos
          - windows
    timeout-minutes: 180
    steps:
      - uses: dtolnay/install-buck2@latest

      - uses: actions/checkout@v3
        with:
          repository: dtolnay-contrib/buck2
          ref: bootstrap
          path: buck2

      - run: rustc --version
        working-directory: buck2

      - uses: actions/cache/restore@v3
        id: cache
        with:
          path: ~/.cargo/bin/reindeer${{matrix.os == 'windows' && '.exe' || ''}}
          key: ${{matrix.os}}-reindeer

      - run: cargo install --git https://github.com/facebookincubator/reindeer reindeer
        if: steps.cache.outputs.cache-hit != 'true'
        working-directory: buck2

      - uses: actions/cache/save@v3
        if: steps.cache.outputs.cache-hit != 'true'
        with:
          path: ~/.cargo/bin/reindeer${{matrix.os == 'windows' && '.exe' || ''}}
          key: ${{steps.cache.outputs.cache-primary-key}}

      - run: reindeer vendor
        working-directory: buck2/shim/third-party/rust

      - run: reindeer buckify
        shell: bash
        working-directory: buck2/shim/third-party/rust

      - uses: egor-tensin/vs-shell@v2

      - run: buck2 build //:buck2 --show-output
        working-directory: buck2
